---
title: "Aim 1 Pilot Analyses"
author: "Ryan Gan"
date: "8/24/2017"
output: html_document
---

## Smoke as an effect modifier

This markdown file contains pilot data exploring the relationship between PM~2.5~ and cardiopulmonary hospital ED or urgent care visits. I am using Washington state CHARS data from 2012. I have time-stratified case-crossover designs. I include an interaction term between PM~2.5~ and a binary indicator of smoke.

Things I want to do: check distribution, try out a couple interaction models in case-crossover and time-series, assemble cohort to get some numbers.

```{r libraries}
library(tidyverse)
library(survival) 
library(contrast)
```

Importing a couple of case-crossover datasets.

```{r import data, echo=F, message=F, warning=F}
# pm2.5 estimates
pm <- read_csv(paste0("./data/pm_data/zip_pm_to_merge_with_chars.csv")) %>% 
  na.omit() %>% 
  # make indicator variable
  mutate(gwr_smk0 = ifelse(geo_smk_pm> 0, 1, 0),
         gwr_smk5 = ifelse(geo_smk_pm> 5, 1, 0),
         gwr_smk10 = ifelse(geo_smk_pm > 10, 1, 0),
         gwr_smk15 = ifelse(geo_smk_pm > 15, 1, 0),
         gwr_smk20 = ifelse(geo_smk_pm > 20, 1, 0))

# all cvd
cvd <- read_csv(paste0("./data/health_data/",
                "cvd1_jul_to_oct_time_strat_casecross.csv")) %>% 
  # make indicator variable
  mutate(gwr_smk0 = ifelse(geo_smk_pm_zip > 0, 1, 0),
         gwr_smk5 = ifelse(geo_smk_pm_zip > 5, 1, 0),
         gwr_smk10 = ifelse(geo_smk_pm_zip > 10, 1, 0),
         gwr_smk15 = ifelse(geo_smk_pm_zip > 15, 1, 0),
         gwr_smk20 = ifelse(geo_smk_pm_zip > 20, 1, 0))
# heart failure
hf <- read_csv(paste0("./data/health_data/",
                "hf1_jul_to_oct_time_strat_casecross.csv")) %>% 
  # make indicator variable
  mutate(gwr_smk0 = ifelse(geo_smk_pm_zip > 0, 1, 0),
         gwr_smk5 = ifelse(geo_smk_pm_zip > 5, 1, 0),
         gwr_smk10 = ifelse(geo_smk_pm_zip > 10, 1, 0),
         gwr_smk15 = ifelse(geo_smk_pm_zip > 15, 1, 0),
         gwr_smk20 = ifelse(geo_smk_pm_zip > 20, 1, 0))
# mi
mi <-  read_csv(paste0("./data/health_data/",
                "mi1_jul_to_oct_time_strat_casecross.csv")) %>% 
  # make indicator variable
  mutate(gwr_smk0 = ifelse(geo_smk_pm_zip > 0, 1, 0),
         gwr_smk5 = ifelse(geo_smk_pm_zip > 5, 1, 0),
         gwr_smk10 = ifelse(geo_smk_pm_zip > 10, 1, 0),
         gwr_smk15 = ifelse(geo_smk_pm_zip > 15, 1, 0),
         gwr_smk20 = ifelse(geo_smk_pm_zip > 20, 1, 0))

# asthma
asthma <-  read_csv(paste0("./data/health_data/",
                "asthma1_jul_to_oct_time_strat_casecross.csv")) %>% 
  # make indicator variable
  mutate(gwr_smk0 = ifelse(geo_smk_pm_zip > 0, 1, 0),
         gwr_smk5 = ifelse(geo_smk_pm_zip > 5, 1, 0),
         gwr_smk10 = ifelse(geo_smk_pm_zip > 10, 1, 0),
         gwr_smk15 = ifelse(geo_smk_pm_zip > 15, 1, 0),
         gwr_smk20 = ifelse(geo_smk_pm_zip > 20, 1, 0))
```

## PM~2.5~ characteristics

Background smoke for a given grid is the median value for that month when smoke is not over the grid, determined by HMS. I subtract backround smoke off the GWR estimate for the grid and population-weight by zipcode. In order to increase the specificity for PM~2.5~ due to wildfire smoke, I'll set a binary cutoff of >10 ug/m^3 above the GWR estimate minus background estimate.I will explore the best way to set a binary cutoff in the grant.

```{r pm distributions, echo=F, message=F, warning=F}
pm_mean <- pm %>% 
  group_by(gwr_smk10) %>% 
  summarise(pm_mean = mean(geo_wt_pm))

plot <- ggplot(data=pm, aes(x=geo_wt_pm, group = as.factor(gwr_smk10))) +
  geom_density(aes(fill = as.factor(gwr_smk10)), alpha = 0.5) +
  scale_fill_manual(values = c("red", "blue")) +
  geom_vline(data = pm_mean, aes(xintercept=pm_mean, group = gwr_smk10),
             color = c("red", "blue"), linetype = "dotted") +
  theme_bw()
# print plot
print(plot)
```

## Asthma

Exploring an interaction model between PM~2.5~ (untransformed) and the binary smoke indicator on asthma.

```{r asthma association}
mod1 <- clogit(outcome ~ geo_wt_pm_zip + gwr_smk10 +
          gwr_smk10*geo_wt_pm_zip + wrf_temp_zip + 
            strata(PATIENTID), data =asthma)

# new data set to fit clogit prediction model on
est_data <- rep(seq(from = 0, to = 200, by = 10), 2) %>% 
  as_tibble() %>% 
  rename(geo_wt_pm_zip = value) %>% 
  group_by(geo_wt_pm_zip) %>% 
  mutate(gwr_smk10 = c(0,1)) %>% 
  ungroup() %>% 
  mutate(PATIENTID= 341,
         wrf_temp_zip = 294) %>% 
  mutate(rr = predict(mod1, newdata=., type = "risk"),
         rel_risk = ifelse(geo_wt_pm_zip < 50 & gwr_smk10 == 0, rr, 
                    ifelse(geo_wt_pm_zip > 50 & gwr_smk10 == 0, NA,
                           rr)),
         risk = rel_risk-1) 
  
ggplot(data = est_data, aes(x = geo_wt_pm_zip, y = risk, color = as.factor(gwr_smk10))) +
  geom_line() + 
  theme_bw()

# need to figure out how to add CI lines.

# non-smoke estimate
pm_est <- mod2 %>% filter(term == "geo_wt_pm_zip") %>% 
  select(term, estimate, std.error)

# smoke estimates
smk_pm_est <- mod2 %>% 
  filter(term == "gwr_smk10" | term == "geo_wt_pm_zip:gwr_smk10") %>% 
  select(term, estimate, std.error)
# extract covariance for the binary indicator and the interaction slope
mod_cov <-vcov(mod1)[4,2]
mod_cov
# calculate new std err
se_pm_smk <- sqrt(smk_pm_est[1,3]^2 + smk_pm_est[2,3]^2 + (2*mod_cov))
se_pm_smk

mod2
# estimates
pm_vals_to_est <- seq(0, 200, by = 10) %>% 
  tibble() %>% 
  rename(pm_val = ".") %>% 
  mutate(beta_pm = pm_val*pm_est[1,2],
         pm_lower = beta_pm - (1.96*pm_est[1,3]),
         pm_upper = beta_pm + (1.96*pm_est[1,3]),
         beta_smk_pm = smk_pm_est[1,2]+(pm_val*smk_pm_est[2,2]),
         smk_pm_lower = beta_smk_pm - (1.96*se_pm_smk),
         smk_pm_upper = beta_smk_pm + (1.96*se_pm_smk))%>% 
  mutate_at(vars(beta_pm:pm_upper),funs(exp(.)-1))


mod2 <- clogit(outcome ~ geo_smk_pm_zip + wrf_temp_zip + 
                strata(PATIENTID), data = asthma)
summary(mod2)
```


```{r cvd association}
mod <- clogit(outcome ~ geo_wt_pm_zip + gwr_smk10 +
        gwr_smk10*geo_wt_pm_zip +
        wrf_temp_zip + strata(PATIENTID), data = cvd)

# new data set to fit clogit prediction model on
est_data <- rep(seq(from = 0, to = 200, by = 10), 2) %>% 
  as_tibble() %>% 
  rename(geo_wt_pm_zip = value) %>% 
  group_by(geo_wt_pm_zip) %>% 
  mutate(gwr_smk10 = c(0,1)) %>% 
  ungroup() %>% 
  mutate(PATIENTID= 226,
         wrf_temp_zip = 294) %>% 
  mutate(rr = predict(mod, newdata=., type = "risk"),
         rel_risk = ifelse(geo_wt_pm_zip < 50 & gwr_smk10 == 0, rr, 
                    ifelse(geo_wt_pm_zip > 50 & gwr_smk10 == 0, NA,
                           rr)),
         risk = rel_risk-1) 

ggplot(data = est_data, aes(x = geo_wt_pm_zip, y = risk, color = as.factor(gwr_smk10))) +
  geom_line() + 
  theme_bw()
```

```{r hf association}
mod <- clogit(outcome ~ geo_wt_pm_zip + gwr_smk10 +
        gwr_smk10*geo_wt_pm_zip +
        wrf_temp_zip + strata(PATIENTID), data = hf)

# new data set to fit clogit prediction model on
est_data <- rep(seq(from = 0, to = 200, by = 10), 2) %>% 
  as_tibble() %>% 
  rename(geo_wt_pm_zip = value) %>% 
  group_by(geo_wt_pm_zip) %>% 
  mutate(gwr_smk10 = c(0,1)) %>% 
  ungroup() %>% 
  mutate(PATIENTID= 226,
         wrf_temp_zip = 294) %>% 
  mutate(rr = predict(mod, newdata=., type = "risk"),
         rel_risk = ifelse(geo_wt_pm_zip < 50 & gwr_smk10 == 0, rr, 
                    ifelse(geo_wt_pm_zip > 50 & gwr_smk10 == 0, NA,
                           rr)),
         risk = rel_risk-1) 

ggplot(data = est_data, aes(x = geo_wt_pm_zip, y = risk, color = as.factor(gwr_smk10))) +
  geom_line() + 
  theme_bw()
```

```{r mi association}
mod <- clogit(outcome ~ geo_wt_pm_zip + gwr_smk10 +
        gwr_smk10*geo_wt_pm_zip +
        wrf_temp_zip + strata(PATIENTID), data = mi)

# new data set to fit clogit prediction model on
est_data <- rep(seq(from = 0, to = 200, by = 10), 2) %>% 
  as_tibble() %>% 
  rename(geo_wt_pm_zip = value) %>% 
  group_by(geo_wt_pm_zip) %>% 
  mutate(gwr_smk10 = c(0,1)) %>% 
  ungroup() %>% 
  mutate(PATIENTID= 2598,
         wrf_temp_zip = 294) %>% 
  mutate(rr = predict(mod, newdata=., type = "risk"),
         rel_risk = ifelse(geo_wt_pm_zip < 50 & gwr_smk10 == 0, rr, 
                    ifelse(geo_wt_pm_zip > 50 & gwr_smk10 == 0, NA,
                           rr)),
         risk = rel_risk-1) 


ggplot(data = est_data, aes(x = geo_wt_pm_zip, y = risk, color = as.factor(gwr_smk10))) +
  geom_line() +
  theme_bw()
```


